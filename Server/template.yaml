AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

Globals:
  Function:
    Runtime: python3.12
    Timeout: 15
    Environment:
      Variables:
        RDS_ENDPOINT: host.docker.internal
        RDS_PORT: 5433
        RDS_USER: postgres
        RDS_DBNAME: trackme
        RDS_PASSWORD: password
        DYNAMODB_ENDPOINT: http://host.docker.internal:8001
        DYNAMODB_REGION: us-west-1
        AWS_ACCESS_KEY_ID: fakeAccessKeyId
        AWS_SECRET_ACCESS_KEY: fakeSecretAccessKey


Resources:
  # API Gateway
  ApiGatewayApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Dev
      Cors:
        AllowMethods: "'POST, GET, OPTIONS'"
        AllowHeaders: "'Content-Type, Authorization'"
        AllowOrigin: "'http://localhost:8081'"
        AllowCredentials: true

  RDSLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: RDSLayer
      Description: RDSLayer utilities
      ContentUri: layers/rds/python/
      CompatibleRuntimes:
        - python3.12
    Metadata:
      BuildMethod: python3.12

  # ATHLETE FUNCTIONS
  SearchCoachesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/athlete/
      Handler: search_coaches
      Events:
        SearchCoachesApi:
          Type: Api
          Properties:
            Path: /athletes/search_coaches/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  RequestCoachFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/athlete/
      Handler: request_coach
      Events:
        RequestCoachApi:
          Type: Api
          Properties:
            Path: /athletes/request_coach/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  UpdateAthleteProfileFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/athlete/
      Handler: update_athlete_profile
      Events:
        UpdateAthleteProfileApi:
          Type: Api
          Properties:
            Path: /athletes/update_athlete_profile/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  ViewWorkoutsAthleteFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/athlete/
      Handler: view_workouts_athlete
      Events:
        ViewWorkoutsAthleteApi:
          Type: Api
          Properties:
            Path: /athletes/view_workouts_athlete/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  GetCoachesFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/athlete/
      Handler: get_coaches
      Events:
        GetCoachesApi:
          Type: Api
          Properties:
            Path: /athletes/get_coaches/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  GetCoachRequestsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/athlete/
      Handler: get_coach_requests
      Events:
        GetCoachRequestsApi:
          Type: Api
          Properties:
            Path: /athletes/get_coach_requests/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  CreateAthleteFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/athlete/
      Handler: create_athlete
      Events:
        CreateAthleteApi:
          Type: Api
          Properties:
            Path: /athletes/create_athlete/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  AcceptCoachInviteFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/athlete/
      Handler: accept_coach_invite
      Events:
        AcceptGroupInviteApi:
          Type: Api
          Properties:
            Path: /athletes/accept_coach_invite/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  InputTimesFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/athlete/
      Handler: input_times
      Events:
        InputTimeApi:
          Type: Api
          Properties:
            Path: /athletes/input_times/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  ViewWorkoutInputsFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/athlete/
      Handler: view_workout_inputs
      Events:
        ViewWorkoutInputsApi:
          Type: Api
          Properties:
            Path: /athletes/view_workout_inputs/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  # COACH FUNCTIONS
  ViewAthleteRequestsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/coach/
      Handler: view_athlete_requests
      Events:
        ViewAthleteRequestsApi:
          Type: Api
          Properties:
            Path: /coaches/view_athlete_requests/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  AcceptAthleteRequestFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/coach/
      Handler: accept_athlete_request
      Events:
        AcceptAthleteRequestApi:
          Type: Api
          Properties:
            Path: /coaches/accept_athlete_request/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  UpdateCoachProfileFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/coach/
      Handler: update_coach_profile
      Events:
        UpdateCoachApi:
          Type: Api
          Properties:
            Path: /coaches/update_coach_profile/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  RemoveGroupAthleteFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/coach/
      Handler: remove_group_athlete
      Events:
        RemoveGroupAthleteApi:
          Type: Api
          Properties:
            Path: /coaches/remove_group_athlete/
            Method: delete
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  DeleteWorkoutFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/coach/
      Handler: delete_workout
      Events:
        DeleteWorkoutApi:
          Type: Api
          Properties:
            Path: /coaches/delete_workout/
            Method: delete
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  GetGroupWorkout:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/coach/
      Handler: get_group_workout
      Events:
        GetGroupWorkoutApi:
          Type: Api
          Properties:
            Path: /coaches/get_group_workout/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  GetWorkoutsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/coach/
      Handler: get_workouts
      Events:
        GetWorkoutsApi:
          Type: Api
          Properties:
            Path: /coaches/get_workouts/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  GetAbsentGroupAthletesFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/coach/
      Handler: get_absent_group_athletes
      Events:
        GetAbsentGroupAthletesApi:
          Type: Api
          Properties:
            Path: /coaches/get_absent_group_athletes/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  AddAthleteToGroupFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/coach/
      Handler: add_athlete_to_group
      Events:
        AddAthleteToGroupApi:
          Type: Api
          Properties:
            Path: /coaches/add_athlete_to_group/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  GetAthletesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/coach/
      Handler: get_athletes
      Events:
        GetAthletesApi:
          Type: Api
          Properties:
            Path: /coaches/get_athletes/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  CreateCoachFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/coach/
      Handler: create_coach
      Events:
        CreateCoachApi:
          Type: Api
          Properties:
            Path: /coaches/create_coach/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  CreateGroupFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/coach/
      Handler: create_group
      Events:
        CreateGroupApi:
          Type: Api
          Properties:
            Path: /coaches/create_group/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  CreateWorkoutFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/coach/
      Handler: create_workout
      Events:
        CreateWorkoutApi:
          Type: Api
          Properties:
            Path: /coaches/create_workout/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  AssignGroupWorkoutFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/coach/
      Handler: assign_group_workout
      Events:
        AssignGroupWorkoutApi:
          Type: Api
          Properties:
            Path: /coaches/assign_group_workout/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  InviteAthleteFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/coach/
      Handler: invite_athlete
      Events:
        InviteAthleteApi:
          Type: Api
          Properties:
            Path: /coaches/invite_athlete/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  SearchAthletesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/coach/
      Handler: search_athletes
      Events:
        SearchAthletesApi:
          Type: Api
          Properties:
            Path: /coaches/search_athletes/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  # GENERAL FUNCTIONS
  RemoveCoachAthlete:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/general/
      Handler: remove_coach_athlete
      Events:
        RemoveCoachAthleteApi:
          Type: Api
          Properties:
            Path: /general/remove_coach_athlete/
            Method: delete
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  GetUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/general/
      Handler: get_user
      Events:
        GetUserApi:
          Type: Api
          Properties:
            Path: /general/get_user/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  ViewGroupInputsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/general/
      Handler: view_group_inputs
      Events:
        ViewGroupInputsApi:
          Type: Api
          Properties:
            Path: /general/view_group_inputs/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  GetAthletesForGroupFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/general/
      Handler: get_athletes_for_group
      Events:
        GetAthletesForGroupApi:
          Type: Api
          Properties:
            Path: /general/get_athletes_for_group/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  GetGroupsFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/general/
      Handler: get_groups
      Events:
        GetGroupsApi:
          Type: Api
          Properties:
            Path: /general/get_groups/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

Outputs:
  ApiGatewayApiUrl:
    Description: "API Gateway endpoint URL for Dev stage"
    Value: !Sub "https://${ApiGatewayApi}.execute-api.${AWS::Region}.amazonaws.com/Dev/"
    
  LocalApiUrl:
    Description: "Local API Gateway endpoint URL"
    Value: "http://127.0.0.1:3000"
