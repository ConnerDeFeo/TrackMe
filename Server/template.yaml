AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

Globals:
  Function:
    Runtime: python3.12
    Timeout: 15
    Environment:
      Variables:
        RDS_ENDPOINT: host.docker.internal
        RDS_PORT: 5433
        RDS_USER: postgres
        RDS_DBNAME: trackme
        RDS_PASSWORD: password
        DYNAMODB_ENDPOINT: http://host.docker.internal:8000
        DYNAMODB_REGION: us-west-1
        AWS_ACCESS_KEY_ID: fakeAccessKeyId
        AWS_SECRET_ACCESS_KEY: fakeSecretAccessKey


Resources:
  # API Gateway
  ApiGatewayApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Dev
      Cors:
        AllowMethods: "'POST, GET, OPTIONS'"
        AllowHeaders: "'Content-Type, Authorization'"
        AllowOrigin: "'http://localhost:8081'"
        AllowCredentials: true

  # Layers
  DynamoDBLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: DynamoDBLayer
      Description: DynamoDBLayer utilities
      ContentUri: layers/dynamo/python/
      CompatibleRuntimes:
        - python3.12
    Metadata:
      BuildMethod: python3.12

  RDSLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: RDSLayer
      Description: RDSLayer utilities
      ContentUri: layers/rds/python/
      CompatibleRuntimes:
        - python3.12
    Metadata:
      BuildMethod: python3.12

  DecimalEncoderLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: DecimalEncoderLayer
      Description: DecimalEncoderLayer utilities
      ContentUri: layers/decimal_encoder/python/
      CompatibleRuntimes:
        - python3.12
    Metadata:
      BuildMethod: python3.12

  # ATHLETE FUNCTIONS
  GetCoachesFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/athlete/get_coaches/
      Handler: get_coaches.get_coaches
      Events:
        GetCoachesApi:
          Type: Api
          Properties:
            Path: /athletes/get_coaches/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  GetCoachRequestsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/athlete/get_coach_requests/
      Handler: get_coach_requests.get_coach_requests
      Events:
        GetCoachRequestsApi:
          Type: Api
          Properties:
            Path: /athletes/get_coach_requests/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  CreateAthleteFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/athlete/create_athlete/
      Handler: create_athlete.create_athlete
      Events:
        CreateAthleteApi:
          Type: Api
          Properties:
            Path: /athletes/create_athlete/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  CreateWorkoutGroupFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/athlete/create_workout_group/
      Handler: create_workout_group.create_workout_group
      Events:
        CreateWorkoutGroupApi:
          Type: Api
          Properties:
            Path: /athletes/create_workout_group/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  AcceptCoachInviteFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/athlete/accept_coach_invite/
      Handler: accept_coach_invite.accept_coach_invite
      Events:
        AcceptGroupInviteApi:
          Type: Api
          Properties:
            Path: /athletes/accept_coach_invite/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  InputTimeFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/athlete/input_time/
      Handler: input_time.input_time
      Events:
        InputTimeApi:
          Type: Api
          Properties:
            Path: /athletes/input_time/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: DynamoDBLayer

  InputGroupTimeFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/athlete/input_group_time/
      Handler: input_group_time.input_group_time
      Events:
        InputGroupTimeApi:
          Type: Api
          Properties:
            Path: /athletes/input_group_time/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: DynamoDBLayer

  ViewWorkoutAthleteFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/athlete/view_workout_athlete/
      Handler: view_workout_athlete.view_workout_athlete
      Events:
        ViewWorkoutAthleteApi:
          Type: Api
          Properties:
            Path: /athletes/view_workout_athlete/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: DynamoDBLayer

  ViewWorkoutInputsFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/athlete/view_workout_inputs/
      Handler: view_workout_inputs.view_workout_inputs
      Events:
        ViewWorkoutInputsApi:
          Type: Api
          Properties:
            Path: /athletes/view_workout_inputs/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: DynamoDBLayer

  # COACH FUNCTIONS
  GetWorkoutsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/coach/get_workouts/
      Handler: get_workouts.get_workouts
      Events:
        GetWorkoutsApi:
          Type: Api
          Properties:
            Path: /coaches/get_workouts/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: DynamoDBLayer
        - Ref: DecimalEncoderLayer

  GetAbsentGroupAthletesFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/coach/get_absent_group_athletes/
      Handler: get_absent_group_athletes.get_absent_group_athletes
      Events:
        GetAbsentGroupAthletesApi:
          Type: Api
          Properties:
            Path: /coaches/get_absent_group_athletes/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  AddAthleteToGroupFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/coach/add_athlete_to_group/
      Handler: add_athlete_to_group.add_athlete_to_group
      Events:
        AddAthleteToGroupApi:
          Type: Api
          Properties:
            Path: /coaches/add_athlete_to_group/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  GetAthletesForGroupFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/coach/get_athletes_for_group/
      Handler: get_athletes_for_group.get_athletes_for_group
      Events:
        GetAthletesForGroupApi:
          Type: Api
          Properties:
            Path: /coaches/get_athletes_for_group/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  GetAthletesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/coach/get_athletes/
      Handler: get_athletes.get_athletes
      Events:
        GetAthletesApi:
          Type: Api
          Properties:
            Path: /coaches/get_athletes/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  CreateCoachFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/coach/create_coach/
      Handler: create_coach.create_coach
      Events:
        CreateCoachApi:
          Type: Api
          Properties:
            Path: /coaches/create_coach/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  CreateGroupFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/coach/create_group/
      Handler: create_group.create_group
      Events:
        CreateGroupApi:
          Type: Api
          Properties:
            Path: /coaches/create_group/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  CreateWorkoutFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/coach/create_workout/
      Handler: create_workout.create_workout
      Events:
        CreateWorkoutApi:
          Type: Api
          Properties:
            Path: /coaches/create_workout/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: DynamoDBLayer

  AssignGroupWorkoutFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/coach/assign_group_workout/
      Handler: assign_group_workout.assign_group_workout
      Events:
        AssignGroupWorkoutApi:
          Type: Api
          Properties:
            Path: /coaches/assign_group_workout/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: DynamoDBLayer

  InviteAthleteFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/coach/invite_athlete/
      Handler: invite_athlete.invite_athlete
      Events:
        InviteAthleteApi:
          Type: Api
          Properties:
            Path: /coaches/invite_athlete/
            Method: post
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  ViewWorkoutCoachFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/coach/view_workout_coach/
      Handler: view_workout_coach.view_workout_coach
      Events:
        ViewWorkoutCoachApi:
          Type: Api
          Properties:
            Path: /coaches/view_workout_coach/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: DynamoDBLayer

  SearchAthletesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/coach/search_athletes/
      Handler: search_athletes.search_athletes
      Events:
        SearchAthletesApi:
          Type: Api
          Properties:
            Path: /coaches/search_athletes/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

  # GENERAL FUNCTIONS
  GetGroupsFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: lambdas/general/get_groups/
      Handler: get_groups.get_groups
      Events:
        GetGroupsApi:
          Type: Api
          Properties:
            Path: /general/get_groups/
            Method: get
            RestApiId: !Ref ApiGatewayApi
      Layers:
        - Ref: RDSLayer

Outputs:
  ApiGatewayApiUrl:
    Description: "API Gateway endpoint URL for Dev stage"
    Value: !Sub "https://${ApiGatewayApi}.execute-api.${AWS::Region}.amazonaws.com/Dev/"
    
  LocalApiUrl:
    Description: "Local API Gateway endpoint URL"
    Value: "http://127.0.0.1:3000"
